<!doctype html>
<html lang="mn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Монгол гэр</title>

<link rel="stylesheet" href="style.css" />
</head>

<body>

<div class="app">
  <aside class="left-col">
    <h2>Монгол гэр</h2>
  </aside>

  <main class="main-col">
    <section class="viewer">
      <div class="viewer-controls">
        <button id="showAll">Бүгдийг харуулах</button>
        <button id="toggleDoor">Хаалга нээх</button>
      </div>
      <div id="canvasWrap" class="canvas-wrap"></div>
    </section>
  </main>
</div>

<!-- ================= THREE JS MODULE ================= -->
<script type="module">

import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160/build/three.module.js";
import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.160/examples/jsm/controls/OrbitControls.js";
import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.160/examples/jsm/loaders/GLTFLoader.js";

const container = document.getElementById('canvasWrap');
const showAllBtn = document.getElementById('showAll');
const toggleDoorBtn = document.getElementById("toggleDoor");

/* RENDERER */
const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(container.clientWidth, container.clientHeight);
renderer.setPixelRatio(window.devicePixelRatio);
container.appendChild(renderer.domElement);

/* SCENE */
const scene = new THREE.Scene();

/* BACKGROUND */
new THREE.TextureLoader().load('panaroma.jpg', tex => {
  tex.mapping = THREE.EquirectangularReflectionMapping;
  scene.background = tex;
});

/* CAMERA */
const camera = new THREE.PerspectiveCamera(
  60,
  container.clientWidth / container.clientHeight,
  0.1,
  2000
);
camera.position.set(0, 16, 50);

/* CONTROLS */
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

/* LIGHTS */
scene.add(new THREE.AmbientLight(0xffffff, 1.5));
const pointLight = new THREE.PointLight(0xffffff, 2, 30);
pointLight.position.set(0, 12, 0);
scene.add(pointLight);

/* GROUND */
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(100, 100),
  new THREE.MeshStandardMaterial({ color: 0x769568 })
);
ground.rotation.x = -Math.PI / 2;
scene.add(ground);

/* LOADER */
const loader = new GLTFLoader();

let gerModel = null;
let doorClosed = null;
let doorOpen = null;
let isDoorOpen = false;

/* LOAD GER */
loader.load("ger.glb", gltf => {
  gerModel = gltf.scene;
  scene.add(gerModel);
});

/* LOAD CLOSED DOOR */
loader.load("haalga1.glb", gltf => {
  doorClosed = gltf.scene;
  scene.add(doorClosed);
});

/* LOAD OPEN DOOR */
loader.load("haalga1_o.glb", gltf => {
  doorOpen = gltf.scene;
  doorOpen.visible = false;
  scene.add(doorOpen);
});

/* DOOR TOGGLE */
function openDoor() {
  if (!doorClosed || !doorOpen) return;
  doorClosed.visible = false;
  doorOpen.visible = true;
  toggleDoorBtn.innerText = "Хаах";
  isDoorOpen = true;
}

function closeDoor() {
  doorClosed.visible = true;
  doorOpen.visible = false;
  toggleDoorBtn.innerText = "Хаалга нээх";
  isDoorOpen = false;
}

toggleDoorBtn.addEventListener("click", () => {
  if (isDoorOpen) closeDoor();
  else openDoor();
});

/* CAMERA FIT */
function fitCameraToObject(object) {
  const box = new THREE.Box3().setFromObject(object);
  const size = box.getSize(new THREE.Vector3()).length();
  const center = box.getCenter(new THREE.Vector3());

  camera.position.copy(center);
  camera.position.z += size * 1.5;

  controls.target.copy(center);
  controls.update();
}

showAllBtn.addEventListener("click", () => {
  if (gerModel) fitCameraToObject(gerModel);
});

/* RESIZE */
window.addEventListener("resize", () => {
  camera.aspect = container.clientWidth / container.clientHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(container.clientWidth, container.clientHeight);
});

/* LOOP */
function animate() {
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}
animate();

</script>

</body>
</html>
