<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Монгол гэр</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app">

    <aside class="left-col">
      <div class="logo">Монгол гэр</div>
      <button id="collapseBtn" class="collapse-btn">⮜</button>

      <nav class="menu">
        <a href="index.html" class="menu-btn active">Үндсэн нүүр</a>
        <a href="gerbarih.html" class="menu-btn">Гэр барих</a>
        <a href="medeelel.html" class="menu-btn">Мэдээлэл</a>
        <a href="togloom.html" class="menu-btn">Тоглоом</a>
        <a href="puzzle.html" class="menu-btn">Puzzle</a>
      </nav>

      <div class="menu-panel" id="menuPanel"></div>
    </aside>

    <button class="mini-open-btn" id="miniOpenBtn">⮞</button>

    <main class="main-col">
      <header class="main-header">
        <h2 id="pageTitle">Үндсэн нүүр</h2>
      </header>

      <section class="viewer">
        <div class="viewer-controls">
          <button id="showAll" class="control-btn primary">Бүгдийг харуулах</button>
          <button id="toggleDoor" class="control-btn">Хаалга нээх</button>
        </div>
        <div id="canvasWrap" class="canvas-wrap"></div>
      </section>

      <section class="bottom-info" id="bottomInfo">
        <h3>Товч мэдээлэл</h3>
        <p>
          Монгол гэр нь нүүдэлчин ахуйн орон байр бөгөөд ёс заншлын чухал хэсэг юм.
          Үндсэн нүүр талбар дээр 3D загварыг харж болно.
        </p>
        <p>
          "Гэр барих" товч дээр дарахад бүрэлдэхүүн хэсгүүд болон барих дараалал харагдах ба тухайн хэсгийг дарж 3D дээр нэг нэгээр гаргана.
        </p>
        <p>
          Гүйцэтгэсэн оюутнууд: В231880017 Г.Бөртэ-Үжин,
          В231880020 Б.Сэржмядаг,
          В231880008 Э.Энхжин
        </p>
      </section>
    </main>
  </div>

  <!-- JS НЭГТГЭСЭН ХЭСЭГ -->
  <script type="module">

import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160/build/three.module.js";
import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.160/examples/jsm/controls/OrbitControls.js";
import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.160/examples/jsm/loaders/GLTFLoader.js";

const container = document.getElementById('canvasWrap');
const showAllBtn = document.getElementById('showAll');
const toggleDoorBtn = document.getElementById("toggleDoor");

const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(container.clientWidth, container.clientHeight);
renderer.setPixelRatio(window.devicePixelRatio);
renderer.outputEncoding = THREE.sRGBEncoding;
container.appendChild(renderer.domElement);

const scene = new THREE.Scene();

new THREE.TextureLoader().load('panaroma.jpg', tex => {
  tex.mapping = THREE.EquirectangularReflectionMapping;
  scene.background = tex;
});

const camera = new THREE.PerspectiveCamera(
  60,
  container.clientWidth / container.clientHeight,
  0.1,
  2000
);
camera.position.set(0, 16, 50);

const controls = new OrbitControls(camera, renderer.domElement);
controls.target.set(0, 1.5, 0);
controls.enableDamping = true;
controls.dampingFactor = 0.05;
controls.maxDistance = 30;
controls.update();

scene.add(new THREE.AmbientLight(0xffffff, 1.5));
const pointLight = new THREE.PointLight(0xffffff, 2, 30);
pointLight.position.set(0, 12, 0);
scene.add(pointLight);
scene.add(new THREE.DirectionalLight(0xffffff, 3));

const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(100, 100),
  new THREE.MeshStandardMaterial({ color: 0x769568 })
);
ground.rotation.x = -Math.PI / 2;
scene.add(ground);

const loader = new GLTFLoader();

let gerModel = null;
let doorClosed = null;
let doorOpen = null;
let isDoorOpen = false;

let animProgress = 0;
let animDirection = 0;
const animSpeed = 0.04;

const hotspot = new THREE.Mesh(
  new THREE.SphereGeometry(0.3, 12, 12),
  new THREE.MeshStandardMaterial({ color: 0xff0000, emissive: 0x550000 })
);
hotspot.position.set(1.4, 5.8, 13);
scene.add(hotspot);

const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

loader.load("ger.glb", gltf => {
  gerModel = gltf.scene;
  scene.add(gerModel);
});

loader.load('haalga1.glb', gltf => {
  doorClosed = gltf.scene;
  scene.add(doorClosed);
  doorClosed.traverse(o => {
    if (o.isMesh) {
      o.material.transparent = true;
      o.material.opacity = 1;
    }
  });
});

loader.load('haalga1_o.glb', gltf => {
  doorOpen = gltf.scene;
  doorOpen.visible = false;
  scene.add(doorOpen);
  doorOpen.traverse(o => {
    if (o.isMesh) {
      o.material.transparent = true;
      o.material.opacity = 0;
    }
  });
});

renderer.domElement.addEventListener("pointerdown", e => {
  if (isDoorOpen) return;

  const r = renderer.domElement.getBoundingClientRect();
  mouse.x = ((e.clientX - r.left) / r.width) * 2 - 1;
  mouse.y = -((e.clientY - r.top) / r.height) * 2 + 1;

  raycaster.setFromCamera(mouse, camera);
  if (raycaster.intersectObject(hotspot).length > 0) openDoor();
});

function openDoor() {
  if (!doorClosed || !doorOpen) return;
  doorClosed.visible = false;
  doorOpen.visible = true;
  animDirection = 1;
  animProgress = 0;
  hotspot.visible = false;
  isDoorOpen = true;
  toggleDoorBtn.innerText = "Хаах";
}

function closeDoor() {
  animDirection = -1;
  animProgress = 1;
  hotspot.visible = true;
  isDoorOpen = false;
  toggleDoorBtn.innerText = "Хаалга нээх";
}

toggleDoorBtn.addEventListener("click", () => {
  if (!isDoorOpen) openDoor();
  else closeDoor();
});

function animate() {
  requestAnimationFrame(animate);

  if (animDirection !== 0 && doorClosed && doorOpen) {
    animProgress += animSpeed * animDirection;
    animProgress = THREE.MathUtils.clamp(animProgress, 0, 1);

    doorClosed.traverse(o => o.isMesh && (o.material.opacity = 1 - animProgress));
    doorOpen.traverse(o => o.isMesh && (o.material.opacity = animProgress));

    if (animProgress === 1 && animDirection === 1) {
      doorClosed.visible = false;
      animDirection = 0;
    }

    if (animProgress === 0 && animDirection === -1) {
      doorOpen.visible = false;
      doorClosed.visible = true;
      animDirection = 0;
    }
  }

  controls.update();
  renderer.render(scene, camera);
}

animate();

  </script>
</body>
</html>
